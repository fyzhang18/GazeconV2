---
title: "GCV2_BabyPilot"
author: "Felicia Zhang"
date: '2017-05-10'
output: html_document
---

```{r}
library(ggplot2) 
library(zoo)
library(reshape)
library(plyr)
library(scales) 
library(data.table)
library(signal)
library(matrixStats)
library(lme4)
library(arm)
#task: 2 conditions (AV, VA randomized), 3 learning trials and then omission 1/3
#raw.fix = read.csv("/Volumes/emberson/ResearchProjects/Pupillometry/GazeConV2/Data/GCV2_fixationreport_2-13.csv")  
raw.sample <- read.csv("/Volumes/emberson/ResearchProjects/Pupillometry/GazeCon/Data/GC1-12_preprocessed_final.csv")
raw.sample$X.1 <- NULL
raw.sample$X <- NULL
is.na(raw.sample$PUPIL_CORRECTED) <- sapply(raw.sample$PUPIL_CORRECTED, is.infinite) #replace infinite value

#label learning trials 1-3, 13-15
raw.sample$learningtrials <- 1
raw.sample$learningtrials[raw.sample$TRIAL_INDEX > 15] <- 0
raw.sample$learningtrials[raw.sample$TRIAL_INDEX > 3 & raw.sample$TRIAL_INDEX < 13] <- 0

poo <- raw.sample
```

X and Y coordinate graph
```{r}
#condition 1: AV
block1 <- subset(raw.sample,condition==1)
doo <- ddply(block1,.(subID,TRIAL_INDEX),summarise,meanY=mean(RIGHT_GAZE_Y,na.rm = TRUE),meanX=mean(RIGHT_GAZE_X,na.rm = TRUE)) 

ggplot(doo,aes(x=meanX,y=meanY,color=factor(subID),fill=factor(subID)))+
  geom_point()+ggtitle("Gaze position during AV")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))

#condition 2: VA
block2 <- subset(raw.sample,condition==2)
doo <- ddply(block2,.(subID,TRIAL_INDEX),summarise,meanY=mean(RIGHT_GAZE_Y,na.rm = TRUE),meanX=mean(RIGHT_GAZE_X,na.rm = TRUE)) 

ggplot(doo,aes(x=meanX,y=meanY,color=factor(subID),fill=factor(subID)))+
  geom_point()+ggtitle("Gaze position during VA")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))

#present trial
present <- subset(raw.sample,trialtype==1)
doo <- ddply(present,.(subID,TRIAL_INDEX),summarise,meanY=mean(RIGHT_GAZE_Y,na.rm = TRUE),meanX=mean(RIGHT_GAZE_X,na.rm = TRUE)) 

ggplot(doo,aes(x=meanX,y=meanY,color=factor(subID),fill=factor(subID)))+
  geom_point()+ggtitle("Gaze position during present")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))

#omission trial
omission <- subset(raw.sample,trialtype==0)
doo <- ddply(omission,.(subID,TRIAL_INDEX),summarise,meanY=mean(RIGHT_GAZE_Y,na.rm = TRUE),meanX=mean(RIGHT_GAZE_X,na.rm = TRUE)) 

ggplot(doo,aes(x=meanX,y=meanY,color=factor(subID),fill=factor(subID)))+
  geom_point()+ggtitle("Gaze position during omission")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))
```

#how many times they actually saw stimuli
```{r}
looking <- subset(raw.sample, SAMPLE_MESSAGE=="LookingAtTarget 1" | SAMPLE_MESSAGE=="LookingAtTarget 2" | SAMPLE_MESSAGE=="LookingAtTarget 3" | SAMPLE_MESSAGE=="LookingAtTarget 3"|SAMPLE_MESSAGE=="LookingAtOmission")

#count how many times they saw target in each trial
looking$count <- 1
subs <- unique(looking$subID)

moo <- data.frame(subID=numeric(),trialnum=numeric(),trialtype=numeric(),condition=numeric(),targetcount=numeric())

for (j in 1:length(subs)) {
  trials <- unique(looking$TRIAL_INDEX[looking$subID==subs[j]])
  print(subs[j])
  for (i in 1:length(trials)) {
    a <- subset(looking, subID==subs[j] & TRIAL_INDEX==trials[i])
    num <- a$count
    if (length(num)==1){
      m <- c(subs[j],trials[i],a$trialtype[1],a$condition[1],1)
      moo <- rbind(moo,m)
    } else {
      for (k in 2:length(num)) {
        diffintime <- a$TIMECODE[k] - a$TIMECODE[k-1]
        if (diffintime > 2000) {
          a$count[k] <- k  
        }
      }
      m <- c(subs[j],trials[i],a$trialtype[1],a$condition[1],max(a$count))
      moo <- rbind(moo,m)
    }
  }}
names(moo)[1] <- "subID"
names(moo)[2] <- "trialnum"
names(moo)[3] <- "trialtype"
names(moo)[4] <- "condition"
names(moo)[5] <- "numtarg"

#bar graph: for condition
doo <- ddply(moo,.(subID,condition),summarise,targseen=sum(numtarg,na.rm = TRUE)) 

ggplot(doo,aes(x=factor(subID),y=targseen,color=factor(condition),fill=factor(condition)))+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  geom_bar(stat="identity")+ggtitle("Number of targets seen")+
  labs(x = "Subject ID", y = "Number of targets")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_y_continuous(limits=c(0,60),breaks=seq(0,60,10))+
  scale_fill_discrete(name="Block",breaks=c("1","2"),labels=c("AV", "VA"))+guides(color=FALSE)

#each trial is 10s long and audio and visual are both 1s each
#max number is ~5 x per trial (5 * 24 = 120)

#bar graph: for trialtype
doo <- ddply(moo,.(subID,trialtype),summarise,targseen=sum(numtarg,na.rm = TRUE)) 

ggplot(doo,aes(x=factor(subID),y=targseen,color=factor(trialtype),fill=factor(trialtype)))+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  geom_bar(stat="identity")+ggtitle("Number of targets seen")+
  labs(x = "Subject ID", y = "Number of targets")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=14),axis.text.y  = element_text(size=14))+
  theme(legend.text=element_text(size=14),legend.title=element_text(size=14))+
  scale_y_continuous(limits=c(0,60),breaks=seq(0,60,10))+
  scale_fill_discrete(name="Trial type",breaks=c("0","1"),labels=c("omission", "present"))+guides(color=FALSE)
```

PDR response (2 x 2: condition x trial type)
Using entire trial duration
```{r}
#compare average pupil response for omission vs present
goo <- ddply(poo,.(subID,condition,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(condition,trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)
label <- c(`1` = "Condition: AV",`2` = "Condition: VA")

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat = "identity")+ggtitle("Average PDR (entire duration)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(-0.05,.2),breaks=seq(-0.05,.2,0.05))+
  facet_wrap(~condition,ncol=2,labeller = as_labeller(label))+theme(strip.text = element_text(size=16))

#removing learning trials
foo <- subset(poo, learningtrials == 0) #remove trials 1-3, 13-15

#compare average pupil response for omission vs present
goo <- ddply(foo,.(subID,condition,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(condition,trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)
label <- c(`1` = "Condition: AV",`2` = "Condition: VA")

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat = "identity")+ggtitle("Average PDR (w/o learning trials)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(-0.05,.2),breaks=seq(-0.05,.2,0.05))+
  facet_wrap(~condition,ncol=2,labeller = as_labeller(label))+
  theme(strip.text = element_text(size=16))
```

PDR response (2 x 2: condition x trial type)
Using only when subjects are looking at target?  **** 
```{r}
#compare average pupil response for omission vs present
goo <- ddply(poo,.(subID,condition,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(condition,trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)
label <- c(`1` = "Condition: Audio -> Visual",`2` = "Condition: Visual -> Audio")

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  theme_bw()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"))+
  geom_bar(stat = "identity")+ggtitle("Average PDR (entire duration)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(0,.2),breaks=seq(0,.2,0.05))+
  facet_wrap(~condition,ncol=2,labeller = as_labeller(label))+theme(strip.text = element_text(size=16))

#removing learning trials
foo <- subset(poo, learningtrials == 0) #remove trials 1-3, 13-15

#compare average pupil response for omission vs present
goo <- ddply(foo,.(subID,condition,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(condition,trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)
label <- c(`1` = "Condition: AV",`2` = "Condition: VA")

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat = "identity")+ggtitle("Average PDR (w/o learning trials)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(-0.05,.2),breaks=seq(-0.05,.2,0.05))+
  facet_wrap(~condition,ncol=2,labeller = as_labeller(label))+
  theme(strip.text = element_text(size=16))
```

PDR response (using only the time when Ss are fixation) 
```{r}
#compare average pupil response for omission vs present
looking <- ddply(coo,.(RECORDING_SESSION_LABEL,CURRENT_FIX_INDEX,CURRENT_FIX_START,CURRENT_FIX_END,TRIAL_INDEX,trialtype),summarise,avglooking=mean(lookingattarget,na.rm = TRUE))
looking <- subset(looking, avglooking==1 )

raw.sample2 <- raw.sample

#for trial 1 only, minus time by 3000 to get correct time
for (j in 1:length(subs)) {
  a <- min(which(raw.sample2$RECORDING_SESSION_LABEL==subs[j] & raw.sample2$TRIAL_INDEX==1))
  aa <- max(which(raw.sample2$RECORDING_SESSION_LABEL==subs[j] & raw.sample2$TRIAL_INDEX==1))
  raw.sample2$TIMECODE[a:aa] <- raw.sample2$TIMECODE[a:aa] - 3000
}

yoo <- data.frame(X= numeric(),RECORDING_SESSION_LABEL= character(), HTARGET_X= numeric(),HTARGET_Y= numeric(),LEFT_GAZE_X= numeric(),LEFT_GAZE_Y= numeric(),LEFT_PUPIL_SIZE= numeric(),RIGHT_GAZE_X= numeric(),RIGHT_GAZE_Y= numeric(),RIGHT_PUPIL_SIZE= numeric(),SAMPLE_INDEX= numeric(),SAMPLE_MESSAGE= character(),TIMESTAMP= numeric(),TRIAL_INDEX= numeric(),phase= numeric(),stimuli1= numeric(),stimuli2= numeric(),trialtype= numeric(),video= numeric(),subID= numeric(),TIMECODE= numeric(),orig= numeric(),rleLength= numeric(),rollmean100ms= numeric(),PUPIL_CORRECTED= numeric(),part= numeric())

#only getting the sample information for times when Ss is looking at target
for (j in 1:length(looking$RECORDING_SESSION_LABEL)) {
  a = looking$RECORDING_SESSION_LABEL[j] #subID
  b = looking$TRIAL_INDEX[j] #trialnum
  c = looking$CURRENT_FIX_START[j] #starttime
  d = looking$CURRENT_FIX_END[j] #endtime
  z <- subset(raw.sample2, RECORDING_SESSION_LABEL==a & TRIAL_INDEX==b & TIMECODE > c-1 & TIMECODE < d+1) 
  
  yoo <- rbind(yoo,z)  
}

#PLOT
goo <- ddply(yoo,.(subID,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat = "identity")+ggtitle("PDR (removing not looking samples)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(0,.35),breaks=seq(0,.35,0.05))

# PDR response: removing learning trials
pooD <- subset(yoo, TRIAL_INDEX > 3)

#compare average pupil response for omission vs present
goo <- ddply(pooD,.(subID,trialtype),summarise,meanPUPIL=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo2 <- ddply(goo,.(trialtype),summarise,meanPUPILSs=mean(meanPUPIL,na.rm = TRUE),sePUPIL=sd(meanPUPIL, na.rm = TRUE)/sqrt(length(meanPUPIL))) #collapse across subjects
limits <- aes(ymax = meanPUPILSs + sePUPIL, ymin=meanPUPILSs - sePUPIL)

ggplot(goo2,aes(x=factor(trialtype),y=meanPUPILSs,color=factor(trialtype),fill=factor(trialtype)))+
  geom_bar(stat = "identity")+ggtitle("PDR (removing not looking samples + no learning trials)")+
  labs(x = "Trial type", y = "Change from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits, width=0.25,color="black")+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+
  theme(legend.position="none")+
  scale_y_continuous(labels=percent,limits=c(0,.35),breaks=seq(0,.35,0.05))

```

time course graph: look at first omission, first present, first trial
```{r cars}
#OMISSION
omissionsonly <- subset(raw.sample, trialtype == 0)

omissionsonly2 <- data.frame(X= numeric(),RECORDING_SESSION_LABEL = numeric(),HTARGET_X= numeric(),HTARGET_Y= numeric(),LEFT_GAZE_X= numeric(),LEFT_GAZE_Y= numeric(),LEFT_PUPIL_SIZE= numeric(),RIGHT_GAZE_X= numeric(),RIGHT_GAZE_Y= numeric(),RIGHT_PUPIL_SIZE= numeric(),SAMPLE_INDEX= numeric(),SAMPLE_MESSAGE= numeric(),TIMESTAMP= numeric(),TRIAL_INDEX= numeric(),phase= numeric(),stimuli1= numeric(),stimuli2= numeric(),trialtype= numeric(),video= numeric(),subID= numeric(),TIMECODE= numeric(),orig= numeric(),rleLength= numeric(),rollmean100ms= numeric(),PUPIL_CORRECTED= numeric(),part= numeric())

subs <- unique(omissionsonly$subID)
for (i in 1:length(subs)) {
  trials <- unique(omissionsonly$TRIAL_INDEX[omissionsonly$subID==subs[i]])
  m <- min(trials)
  x <- subset(omissionsonly, subID ==subs[i] & TRIAL_INDEX == m)
  omissionsonly2  <- rbind(omissionsonly2,x)
}

#remove samples with no messages
omissionsonly3 <- omissionsonly2[!grepl("Invalid", omissionsonly2$SAMPLE_MESSAGE),] #removed rows when Ss are not looking at the screen
omissionsonly3$lookingattarget <- 0
omissionsonly3$lookingattarget[grepl("LookingAtTarget 1", omissionsonly3$SAMPLE_MESSAGE)] <- 1
omissionsonly3$lookingattarget[grepl("LookingAtTarget 2", omissionsonly3$SAMPLE_MESSAGE)] <- 1
omissionsonly3$lookingattarget[grepl("LookingAtTarget 3", omissionsonly3$SAMPLE_MESSAGE)] <- 1
omissionsonly3$lookingattarget[grepl("LookingAtTarget 4", omissionsonly3$SAMPLE_MESSAGE)] <- 1

#create new timecode to timelock it to when they first look at image
subs <- unique(omissionsonly$subID)
omissionsonly3$timecode2 <- 0
for (i in 1:length(subs)) {
  m <- min(which(omissionsonly3$lookingattarget==1 &omissionsonly3$subID==subs[i]))
  timestart <- omissionsonly3$TIMECODE[m]
  start <- min(which(omissionsonly3$subID==subs[i]))
  end <- max(which(omissionsonly3$subID==subs[i]))
  omissionsonly3$timecode2[start:end] <- omissionsonly3$TIMECODE[start:end] - timestart
}
omissionsonly3$trialtype3 <- 0

#FIRST TRIAL
firstsonly2 <- subset(raw.sample, TRIAL_INDEX == 1)

#remove samples with no messages
firstsonly3 <- firstsonly2[!grepl("Invalid", firstsonly2$SAMPLE_MESSAGE),] #removed rows when Ss are not looking at the screen
firstsonly3$lookingattarget <- 0
firstsonly3$lookingattarget[grepl("LookingAtTarget 1", firstsonly3$SAMPLE_MESSAGE)] <- 1
firstsonly3$lookingattarget[grepl("LookingAtTarget 2", firstsonly3$SAMPLE_MESSAGE)] <- 1
firstsonly3$lookingattarget[grepl("LookingAtTarget 3", firstsonly3$SAMPLE_MESSAGE)] <- 1
firstsonly3$lookingattarget[grepl("LookingAtTarget 4", firstsonly3$SAMPLE_MESSAGE)] <- 1

#create new timecode to timelock it to when they first look at image
subs <- unique(firstsonly2$subID)
firstsonly3$timecode2 <- 0
for (i in 1:length(subs)) {
  m <- min(which(firstsonly3$lookingattarget==1 &firstsonly3$subID==subs[i]))
  timestart <- firstsonly3$TIMECODE[m]
  start <- min(which(firstsonly3$subID==subs[i]))
  end <- max(which(firstsonly3$subID==subs[i]))
  firstsonly3$timecode2[start:end] <- firstsonly3$TIMECODE[start:end] - timestart
}

firstsonly3$trialtype3 <- 1

#FIRST PRESENT AFTER LEARNING
presentonly <- subset(raw.sample, trialtype2 == 1 & TRIAL_INDEX > 5)

presentonly2 <- data.frame(X= numeric(),RECORDING_SESSION_LABEL = numeric(),HTARGET_X= numeric(),HTARGET_Y= numeric(),LEFT_GAZE_X= numeric(),LEFT_GAZE_Y= numeric(),LEFT_IN_BLINK= numeric(),LEFT_PUPIL_SIZE= numeric(),RIGHT_GAZE_X= numeric(),RIGHT_GAZE_Y= numeric(),RIGHT_IN_BLINK= numeric(),RIGHT_PUPIL_SIZE= numeric(),SAMPLE_INDEX= numeric(),SAMPLE_MESSAGE= numeric(),TIMESTAMP= numeric(),TRIAL_INDEX= numeric(),trialtype= numeric(),trialtype2= numeric(),imageseen1= numeric(),imageseen2= numeric(),subID= numeric(),TIMECODE= numeric(),orig= numeric(),rleLength= numeric(),rollmean100ms= numeric(),PUPIL_CORRECTED= numeric())

subs <- unique(presentonly$subID)
for (i in 1:length(subs)) {
  trials <- unique(presentonly$TRIAL_INDEX[presentonly$subID==subs[i]])
  m <- min(trials)
  x <- subset(presentonly, subID ==subs[i] & TRIAL_INDEX == m)
  presentonly2  <- rbind(presentonly2,x)
}

#remove samples with no messages
presentonly3 <- presentonly2[!grepl("Invalid", presentonly2$SAMPLE_MESSAGE),] #removed rows when Ss are not looking at the screen
presentonly3$lookingattarget <- 0
presentonly3$lookingattarget[grepl("LookingAtTarget 1", presentonly3$SAMPLE_MESSAGE)] <- 1
presentonly3$lookingattarget[grepl("LookingAtTarget 2", presentonly3$SAMPLE_MESSAGE)] <- 1
presentonly3$lookingattarget[grepl("LookingAtTarget 3", presentonly3$SAMPLE_MESSAGE)] <- 1
presentonly3$lookingattarget[grepl("LookingAtTarget 4", presentonly3$SAMPLE_MESSAGE)] <- 1

#create new timecode to timelock it to when they first look at image
subs <- unique(presentonly$subID)
presentonly3$timecode2 <- 0
for (i in 1:length(subs)) {
  m <- min(which(presentonly3$lookingattarget==1 &presentonly3$subID==subs[i]))
  timestart <- presentonly3$TIMECODE[m]
  start <- min(which(presentonly3$subID==subs[i]))
  end <- max(which(presentonly3$subID==subs[i]))
  presentonly3$timecode2[start:end] <- presentonly3$TIMECODE[start:end] - timestart
}
presentonly3$trialtype3 <- 2

#timecourse plot
combo <- rbind(omissionsonly3,presentonly3,firstsonly3)
#collapse across subjects
doo <- ddply(combo,.(trialtype3,timecode2),summarise,avg.pupil=mean(PUPIL_CORRECTED,na.rm = TRUE),sePupil=sd(PUPIL_CORRECTED, na.rm = TRUE)/sqrt(length(PUPIL_CORRECTED))) #collapse across trials

ggplot(doo,aes(x=timecode2,y=avg.pupil,fill=factor(trialtype3),colour=factor(trialtype3)))+
  geom_line()+ggtitle("Pupil change locked to first gaze on object")+
  labs(x = "Time (ms) from first gaze on object", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_y_continuous(labels=percent,limits=c(-0.3,.3),breaks=seq(-0.3,0.3,0.2))+
  scale_x_continuous(limits=c(-500,9000),breaks=seq(-500,9000,1000))+geom_vline(xintercept = 0)+
  geom_ribbon(aes(ymin=avg.pupil-sePupil,ymax=avg.pupil+sePupil),alpha=0.5)+scale_fill_discrete(name="Trial Type", breaks=c("0", "1","2"),labels=c("First omission", "First trial", "First present (after learning block)"))+guides(color=FALSE)

ggplot(doo,aes(x=timecode2,y=avg.pupil,fill=factor(trialtype3),colour=factor(trialtype3)))+
  geom_line()+ggtitle("Pupil change locked to first gaze on object")+
  labs(x = "Time (ms) from first gaze on object", y = "Pupil change from baseline (%)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_y_continuous(labels=percent,limits=c(-0.3,.3),breaks=seq(-0.3,0.3,0.2))+
  scale_x_continuous(limits=c(-500,4000),breaks=seq(-500,4000,500))+geom_vline(xintercept = 0)+
  geom_ribbon(aes(ymin=avg.pupil-sePupil,ymax=avg.pupil+sePupil),alpha=0.5)+scale_fill_discrete(name="Trial Type", breaks=c("0", "1","2"),labels=c("First omission", "First trial", "First present (after learning block)"))+guides(color=FALSE)

```


Look at changes across the trials: number of switches
```{r}
#number of switches
goo4 <- ddply(subjectSummary4,.(subID,trialtype2,trialnum),summarise,avg.switches.Ss=mean(switches,na.rm = TRUE)) 
goo4.o <- subset(goo4, trialtype2==0)
goo4.p <- subset(goo4, trialtype2==1)
goo4.o$trialnum2 <- 0
goo4.p$trialnum2 <- 0
goo4.p <- subset(goo4.p, trialnum > 6) #remove learning trials

#relabel trial
subs <- unique(goo4.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.o$trialnum[goo4.o$subID==subs[j]])
  goo4.o$trialnum2[goo4.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo4.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.p$trialnum[goo4.p$subID==subs[j]])
  goo4.p$trialnum2[goo4.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo8 <- ddply(goo4.o,.(trialnum2),summarise,avg.switch=mean(avg.switches.Ss,na.rm = TRUE),seSwitch=sd(avg.switches.Ss, na.rm = TRUE)/sqrt(length(avg.switches.Ss))) 
limits5 <- aes(ymax = avg.switch + seSwitch, ymin=avg.switch - seSwitch)
cortest1 <-cor.test(goo8$trialnum2, goo8$avg.switch, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo8,aes(x=trialnum2,y=avg.switch))+
  geom_point()+ggtitle("Omission switches change")+
  labs(x = "Times seen omission after learning block", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,7),breaks=seq(0,7,1))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,6),breaks=seq(0,6,1))+annotate("text", x = 3, y = 6, label = "cor = -0.22, p=0.72",size=10)

#present
goo9 <- ddply(goo4.p,.(trialnum2),summarise,avg.switch=mean(avg.switches.Ss,na.rm = TRUE),seSwitch=sd(avg.switches.Ss, na.rm = TRUE)/sqrt(length(avg.switches.Ss))) 
limits5 <- aes(ymax = avg.switch + seSwitch, ymin=avg.switch - seSwitch)
cortest1 <-cor.test(goo9$trialnum2, goo9$avg.switch, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo9,aes(x=trialnum2,y=avg.switch))+
  geom_point()+ggtitle("Present switches change")+
  labs(x = "Times seen present after learning block", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,7),breaks=seq(0,7,1))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,8),breaks=seq(0,8,1))+annotate("text", x = 4, y = 6, label = "cor = -0.62, p=0.13",size=10)
```

Look at changes across the trials: % looking at images
```{r}
#total looking percent
goo4 <- ddply(subjectSummary4,.(subID,trialtype2,trialnum),summarise,avg.totallook.Ss=mean(totallookingpercent,na.rm = TRUE)) 
goo4.o <- subset(goo4, trialtype2==0)
goo4.p <- subset(goo4, trialtype2==1)
goo4.o$trialnum2 <- 0
goo4.p$trialnum2 <- 0
#goo4.p <- subset(goo4.p, trialnum > 6) #remove learning trials

#relabel trial
subs <- unique(goo4.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.o$trialnum[goo4.o$subID==subs[j]])
  goo4.o$trialnum2[goo4.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo4.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.p$trialnum[goo4.p$subID==subs[j]])
  goo4.p$trialnum2[goo4.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo8 <- ddply(goo4.o,.(trialnum2),summarise,avg.totallook=mean(avg.totallook.Ss,na.rm = TRUE),setotallook=sd(avg.totallook.Ss, na.rm = TRUE)/sqrt(length(avg.totallook.Ss))) 
limits5 <- aes(ymax = avg.totallook + setotallook, ymin=avg.totallook - setotallook)
cortest1 <-cor.test(goo8$trialnum2, goo8$avg.totallook, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo8,aes(x=trialnum2,y=avg.totallook))+
  geom_point()+ggtitle("Omission percent looking at images")+
  labs(x = "Times seen omission after learning block", y = "percent looking at images")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_y_continuous(labels=percent,limits=c(0,1),breaks=seq(0,1,0.25))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,6),breaks=seq(0,6,1))+annotate("text", x = 3, y = 0.3, label = "cor = -0.08, p=0.9",size=10)

#present
goo9 <- ddply(goo4.p,.(trialnum2),summarise,avg.totallook=mean(avg.totallook.Ss,na.rm = TRUE),seSwitch=sd(avg.totallook.Ss, na.rm = TRUE)/sqrt(length(avg.totallook.Ss))) 
limits5 <- aes(ymax = avg.totallook + setotallook, ymin=avg.totallook - setotallook)
cortest1 <-cor.test(goo9$trialnum2, goo9$avg.totallook, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo9,aes(x=trialnum2,y=avg.totallook))+
  geom_point()+ggtitle("Present percent looking at images")+
  labs(x = "Times seen present after learning block", y = "percent looking at images")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_y_continuous(labels=percent,limits=c(0,1),breaks=seq(0,1,0.25))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,8),breaks=seq(0,8,1))+annotate("text", x = 4, y = 0.3, label = "cor = -0.16, p=0.72",size=10)

```

Collapsed across trial type
```{r cars}
#number of switches
subjectSummary5 <- subset(subjectSummary4, trialnum > 6)
goo4 <- ddply(subjectSummary5,.(subID,trialtype2),summarise,avg.switches.numSs=mean(switches,na.rm = TRUE),seSwitches=sd(switches, na.rm = TRUE)/sqrt(length(switches))) #collapse across trials
limits4 <- aes(ymax = avg.switches.numSs + seSwitches, ymin=avg.switches.numSs - seSwitches)
dodge <- position_dodge(width=0.9)

ggplot(goo4,aes(x=factor(subID),y=avg.switches.numSs,color=factor(trialtype2),fill=factor(trialtype2)))+
  geom_bar(stat = "identity",position=dodge)+ggtitle("Number of switches")+
  labs(x = "Subject", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits4, width=0.25,color="black",position=dodge)+
  scale_fill_discrete(name="Trial Type",breaks=c("0","1"),labels=c("Omission", "Present"))+
  guides(color=FALSE)+scale_y_continuous(limits=c(0,8),breaks=seq(0,8,1))

goo44 <- ddply(goo4,.(trialtype2),summarise,avg.switch=mean(avg.switches.numSs,na.rm = TRUE),seSwitch=sd(avg.switches.numSs, na.rm = TRUE)/sqrt(length(avg.switches.numSs))) 
limits4 <- aes(ymax = avg.switch + seSwitch, ymin=avg.switch - seSwitch)
dodge <- position_dodge(width=0.9)

ggplot(goo44,aes(x=factor(trialtype2),y=avg.switch,color=factor(trialtype2),fill=factor(trialtype2)))+
  geom_bar(stat = "identity",position=dodge)+ggtitle("Number of switches")+
  labs(x = "Trial Type", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits4, width=0.25,color="black",position=dodge)+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+theme(legend.position="none")+scale_y_continuous(limits=c(0,4),breaks=seq(0,4,1))

#percent looking at object
goo3 <- ddply(subjectSummary5,.(subID,trialtype2),summarise,avg.totallook.numSs=mean(totallookingpercent,na.rm = TRUE),setotallook=sd(totallookingpercent, na.rm = TRUE)/sqrt(length(totallookingpercent))) #collapse across trials
limits3 <- aes(ymax = avg.totallook.numSs + setotallook, ymin=avg.totallook.numSs - setotallook)
dodge <- position_dodge(width=0.9)

ggplot(goo3,aes(x=factor(subID),y=avg.totallook.numSs,color=factor(trialtype2),fill=factor(trialtype2)))+
  geom_bar(stat = "identity",position=dodge)+ggtitle("Percent looking at imgs on screen")+
  labs(x = "Subject", y = "Percent looking")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits3, width=0.25,color="black",position=dodge)+
  scale_fill_discrete(name="Trial Type",breaks=c("0","1"),labels=c("Omission", "Present"))+
  guides(color=FALSE)+scale_y_continuous(labels=percent,limits=c(0,1),breaks=seq(0,1,0.25))

goo33 <- ddply(goo3,.(trialtype2),summarise,avg.totallook=mean(avg.totallook.numSs,na.rm = TRUE),setotallook=sd(avg.totallook.numSs, na.rm = TRUE)/sqrt(length(avg.totallook.numSs))) 
limits3 <- aes(ymax = avg.totallook + setotallook, ymin=avg.totallook - setotallook)
dodge <- position_dodge(width=0.9)

ggplot(goo33,aes(x=factor(trialtype2),y=avg.totallook,color=factor(trialtype2),fill=factor(trialtype2)))+
  geom_bar(stat = "identity",position=dodge)+ggtitle("Percent looking at imgs on screen")+
  labs(x = "Trial Type", y = "Percent looking")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  geom_errorbar(limits3, width=0.25,color="black",position=dodge)+
  scale_x_discrete(breaks=c("0","1"),labels=c("Omission", "Present"))+theme(legend.position="none")+scale_y_continuous(labels=percent,limits=c(0,1),breaks=seq(0,1,0.25))

```

Gaze patterns
```{r}
#remove time when Ss is watching video
poo <- raw.sample
subs <- unique(poo$subID)
for (j in 1:length(subs)) {
  trials <- unique(poo$TRIAL_INDEX[poo$subID==subs[j]])
  for (i in 1:length(trials)) {
    start <-  which(poo$TRIAL_INDEX == trials[i] & poo$subID==subs[j] & poo$SAMPLE_MESSAGE == "BaselineVideo")
    end <- max(which(poo$TRIAL_INDEX == trials[i] & poo$subID==subs[j]))
    poo <-  poo[-(start:end),]
  }}

#2. remove gazes that are off the screen
a <- which(poo$RIGHT_GAZE_X < 0)
poo <- poo[-c(a), ] 
a <- which(poo$RIGHT_GAZE_Y < 0)
poo <- poo[-c(a), ] 
a <- which(poo$RIGHT_GAZE_X > 1280)
poo <- poo[-c(a), ] 
a <- which(poo$RIGHT_GAZE_Y > 1024)
poo <- poo[-c(a), ] 

#collapse across all subs
goo <- ddply(poo,.(subID,TIMECODE,trialtype2),summarise,avg.X.Ss=mean(RIGHT_GAZE_X,na.rm = TRUE),avg.Y.Ss=mean(RIGHT_GAZE_Y,na.rm = TRUE))
goo2 <- ddply(goo,.(TIMECODE,trialtype2),summarise,avg.X=mean(avg.X.Ss,na.rm = TRUE),seX=sd(avg.X.Ss, na.rm = TRUE)/sqrt(length(avg.X.Ss)),avg.Y=mean(avg.Y.Ss,na.rm = TRUE),seY=sd(avg.Y.Ss, na.rm = TRUE)/sqrt(length(avg.Y.Ss))) 

ggplot(goo2,aes(x=avg.X,y=avg.Y,color=factor(trialtype2), fill=factor(trialtype2)))+
  geom_point()+ggtitle("Gaze position: omission vs present")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))+scale_color_discrete(name="Trial Type",breaks=c("0","1"),labels=c("Omission", "Present"))+guides(fill=FALSE)

#facet wrap every subject
goo <- ddply(poo,.(subID,TIMECODE,trialtype2),summarise,avg.X.Ss=mean(RIGHT_GAZE_X,na.rm = TRUE),avg.Y.Ss=mean(RIGHT_GAZE_Y,na.rm = TRUE))

ggplot(goo,aes(x=avg.X.Ss,y=avg.Y.Ss,color=factor(trialtype2), fill=factor(trialtype2)))+
  geom_point()+ggtitle("Gaze position: omission vs present")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))+facet_wrap(~subID)+scale_color_discrete(name="Trial Type",breaks=c("0","1"),labels=c("Omission", "Present"))+guides(fill=FALSE)

#facet wrap every trial for one subject
loo <- subset(poo, subID==3)
loo <- subset(loo, TRIAL_INDEX < 40)
ggplot(loo,aes(x=RIGHT_GAZE_X,y=RIGHT_GAZE_Y,color=factor(trialtype2), fill=TIMECODE))+
  geom_point()+ggtitle("Gaze position: omission vs present")+
  labs(x = "X coordinate", y = "Y coordinate")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+
  scale_x_continuous(limits=c(0,1280),breaks=seq(0,1280,300),position="top")+
  scale_y_reverse(limits = c(1024, 0))+facet_wrap(~TRIAL_INDEX)+theme(legend.position="none")

```




Look at changes across the trials: PDR
```{r}
#PDR
goo <- ddply(poo,.(subID,trialtype2,TRIAL_INDEX),summarise,meanPupilSs=mean(PUPIL_CORRECTED,na.rm = TRUE))
goo.o <- subset(goo, trialtype2==0)
goo.p <- subset(goo, trialtype2==1)
goo.o$trialnum <- 0
goo.p$trialnum <- 0

#relabel trial
subs <- unique(goo.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo.o$TRIAL_INDEX[goo.o$subID==subs[j]])
  goo.o$trialnum[goo.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo.p$TRIAL_INDEX[goo.p$subID==subs[j]])
  goo.p$trialnum[goo.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo5 <- ddply(goo.o,.(trialnum),summarise,meanPupil=mean(meanPupilSs,na.rm = TRUE),sePupil=sd(meanPupilSs, na.rm = TRUE)/sqrt(length(meanPupilSs))) 
limits5 <- aes(ymax = meanPupil + sePupil, ymin=meanPupil - sePupil)
cortest1 <-cor.test(goo5$trialnum, goo5$meanPupil, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo5,aes(x=trialnum,y=meanPupil))+
  geom_point()+ggtitle("Omission PDR Change")+
  labs(x = "Trial Number", y = "PDR from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(labels=percent,limits=c(-0.3,.3),breaks=seq(-0.3,.3,0.1))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,7),breaks=seq(0,7,1))+annotate("text", x = 5, y = -.2, label = "cor = 0.5, p=0.31",size=10)

#present
goo6 <- ddply(goo.p,.(trialnum),summarise,meanPupil=mean(meanPupilSs,na.rm = TRUE),sePupil=sd(meanPupilSs, na.rm = TRUE)/sqrt(length(meanPupilSs))) 
limits6 <- aes(ymax = meanPupil + sePupil, ymin=meanPupil - sePupil)
cortest2 <-cor.test(goo6$trialnum, goo6$meanPupil, alternative = "two.sided", method = "pearson")
cortest2

ggplot(goo6,aes(x=trialnum,y=meanPupil))+
  geom_point()+ggtitle("Present PDR Change")+
  labs(x = "Trial Number", y = "PDR from baseline")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(labels=percent,limits=c(-0.2,.25),breaks=seq(-0.2,.25,0.05))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,15),breaks=seq(0,15,2))+annotate("text", x = 10, y = -.15, label = "cor = -0.26, p=0.33",size=10)
```

Look at changes across the trials: fixation duration
```{r}
#fixation duration
goo2 <- ddply(subjectSummary2,.(subID,trialtype2,trialnum),summarise,avg.fixation.durationSs=mean(avg.fixation.duration,na.rm = TRUE)) 

goo2.o <- subset(goo2, trialtype2==0)
goo2.p <- subset(goo2, trialtype2==1)
goo2.o$trialnum2 <- 0
goo2.p$trialnum2 <- 0

#relabel trial
subs <- unique(goo2.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo2.o$trialnum[goo2.o$subID==subs[j]])
  goo2.o$trialnum2[goo2.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo2.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo2.p$trialnum[goo2.p$subID==subs[j]])
  goo2.p$trialnum2[goo2.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo5 <- ddply(goo2.o,.(trialnum2),summarise,avg.fixation.duration=mean(avg.fixation.durationSs,na.rm = TRUE),seFixationDuration=sd(avg.fixation.durationSs, na.rm = TRUE)/sqrt(length(avg.fixation.durationSs))) 
limits5 <- aes(ymax = avg.fixation.duration + seFixationDuration, ymin=avg.fixation.duration - seFixationDuration)
cortest1 <-cor.test(goo5$trialnum, goo5$avg.fixation.duration, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo5,aes(x=trialnum2,y=avg.fixation.duration))+
  geom_point()+ggtitle("Omission fixation duration change")+
  labs(x = "Trial Number", y = "Fixation duration (ms)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,1000),breaks=seq(0,1000,200))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,7),breaks=seq(0,7,1))+annotate("text", x = 5, y = 200, label = "cor = -0.38, p=0.45",size=10)

#present
goo6 <- ddply(goo2.p,.(trialnum2),summarise,avg.fixation.duration=mean(avg.fixation.durationSs,na.rm = TRUE),seFixationDuration=sd(avg.fixation.durationSs, na.rm = TRUE)/sqrt(length(avg.fixation.durationSs))) 
limits5 <- aes(ymax = avg.fixation.duration + seFixationDuration, ymin=avg.fixation.duration - seFixationDuration)
cortest2 <-cor.test(goo6$trialnum, goo6$avg.fixation.duration, alternative = "two.sided", method = "pearson")
cortest2

ggplot(goo6,aes(x=trialnum2,y=avg.fixation.duration))+
  geom_point()+ggtitle("Present fixation duration change")+
  labs(x = "Trial Number", y = "Fixation duration (ms)")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,1000),breaks=seq(0,1000,200))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,15),breaks=seq(0,15,2))+annotate("text", x = 10, y = 200, label = "cor = -0.55, p=0.02*",size=10)
```

Look at changes across the trials: fixation count
```{r}
#number of fixations
goo3 <- ddply(subjectSummary2,.(subID,trialtype2,trialnum),summarise,avg.fixation.countSs=mean(TRIAL_FIXATION_TOTAL,na.rm = TRUE)) 

goo3.o <- subset(goo3, trialtype2==0)
goo3.p <- subset(goo3, trialtype2==1)
goo3.o$trialnum2 <- 0
goo3.p$trialnum2 <- 0

#relabel trial
subs <- unique(goo3.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo3.o$trialnum[goo3.o$subID==subs[j]])
  goo3.o$trialnum2[goo3.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo3.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo3.p$trialnum[goo3.p$subID==subs[j]])
  goo3.p$trialnum2[goo3.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo7 <- ddply(goo3.o,.(trialnum2),summarise,avg.fixation.count=mean(avg.fixation.countSs,na.rm = TRUE),seFixationCount=sd(avg.fixation.countSs, na.rm = TRUE)/sqrt(length(avg.fixation.countSs))) 
limits5 <- aes(ymax = avg.fixation.count + seFixationCount, ymin=avg.fixation.count - seFixationCount)
cortest3 <-cor.test(goo7$trialnum, goo7$avg.fixation.count, alternative = "two.sided", method = "pearson")
cortest3

ggplot(goo7,aes(x=trialnum2,y=avg.fixation.count))+
  geom_point()+ggtitle("Omission fixation count change")+
  labs(x = "Trial Number", y = "Number of fixations")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,40),breaks=seq(0,40,5))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,7),breaks=seq(0,7,1))+annotate("text", x = 5, y = 10, label = "cor = 0.15, p=0.77",size=10)

#present
goo6 <- ddply(goo3.p,.(trialnum2),summarise,avg.fixation.count=mean(avg.fixation.countSs,na.rm = TRUE),seFixationDuration=sd(avg.fixation.countSs, na.rm = TRUE)/sqrt(length(avg.fixation.countSs))) 
limits5 <- aes(ymax = avg.fixation.duration + seFixationDuration, ymin=avg.fixation.duration - seFixationDuration)
cortest2 <-cor.test(goo6$trialnum, goo6$avg.fixation.count, alternative = "two.sided", method = "pearson")
cortest2

ggplot(goo6,aes(x=trialnum2,y=avg.fixation.count))+
  geom_point()+ggtitle("Present fixation count change")+
  labs(x = "Trial Number", y = "Number of fixations")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,50),breaks=seq(0,50,5))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,15),breaks=seq(0,15,2))+annotate("text", x = 8, y = 5, label = "cor = 0.26, p=0.31",size=10)
```

Look at changes across the trials: number of switches
```{r}
#number of switches
goo4 <- ddply(subjectSummary3,.(subID,trialtype2,trialnum),summarise,avg.switches.Ss=mean(switches,na.rm = TRUE)) 
goo4.o <- subset(goo4, trialtype2==0)
goo4.p <- subset(goo4, trialtype2==1)
goo4.o$trialnum2 <- 0
goo4.p$trialnum2 <- 0

#relabel trial
subs <- unique(goo4.o$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.o$trialnum[goo4.o$subID==subs[j]])
  goo4.o$trialnum2[goo4.o$subID==subs[j]] <- 1:length(trials)
}

subs <- unique(goo4.p$subID)
for (j in 1:length(subs)) {
  trials <- unique(goo4.p$trialnum[goo4.p$subID==subs[j]])
  goo4.p$trialnum2[goo4.p$subID==subs[j]] <- 1:length(trials)
}

#omission plot
goo8 <- ddply(goo4.o,.(trialnum2),summarise,avg.switch=mean(avg.switches.Ss,na.rm = TRUE),seSwitch=sd(avg.switches.Ss, na.rm = TRUE)/sqrt(length(avg.switches.Ss))) 
limits5 <- aes(ymax = avg.switch + seSwitch, ymin=avg.switch - seSwitch)
cortest1 <-cor.test(goo8$trialnum, goo8$avg.switch, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo8,aes(x=trialnum2,y=avg.switch))+
  geom_point()+ggtitle("Omission switches change")+
  labs(x = "Trial Number", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,6),breaks=seq(0,6,1))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,7),breaks=seq(0,7,1))+annotate("text", x = 3, y = 5, label = "cor = 0.31, p=0.55",size=10)

#present
goo9 <- ddply(goo4.p,.(trialnum2),summarise,avg.switch=mean(avg.switches.Ss,na.rm = TRUE),seSwitch=sd(avg.switches.Ss, na.rm = TRUE)/sqrt(length(avg.switches.Ss))) 
limits5 <- aes(ymax = avg.switch + seSwitch, ymin=avg.switch - seSwitch)
cortest1 <-cor.test(goo9$trialnum, goo9$avg.switch, alternative = "two.sided", method = "pearson")
cortest1

ggplot(goo9,aes(x=trialnum2,y=avg.switch))+
  geom_point()+ggtitle("Present switches change")+
  labs(x = "Trial Number", y = "Number of switches")+
  theme(plot.title = element_text(face="bold", size=20, hjust=0))+
  theme(axis.title = element_text(face="bold", size=20))+ 
  theme(axis.text.x  = element_text(size=20),axis.text.y  = element_text(size=20))+
  theme(legend.text=element_text(size=16),legend.title=element_text(size=16))+scale_y_continuous(limits=c(0,7),breaks=seq(0,7,1))+stat_smooth(method=lm)+scale_x_continuous(limits=c(0,15),breaks=seq(0,15,2))+annotate("text", x = 10, y = 6, label = "cor = -0.35, p=0.18",size=10)


```
